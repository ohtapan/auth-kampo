{"id":"node_modules/@aws-amplify/auth/lib/OAuth/OAuth.js","dependencies":[{"name":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\@aws-amplify\\auth\\lib\\OAuth\\OAuth.js.map","includedInParent":true,"mtime":1557861885000},{"name":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\@aws-amplify\\auth\\src\\OAuth\\OAuth.ts","includedInParent":true,"mtime":1557861738000},{"name":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\@aws-amplify\\auth\\package.json","includedInParent":true,"mtime":1560308010597},{"name":"url","loc":{"line":58,"column":20},"parent":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\@aws-amplify\\auth\\lib\\OAuth\\OAuth.js","resolved":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\url\\url.js"},{"name":"./urlOpener","loc":{"line":59,"column":26},"parent":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\@aws-amplify\\auth\\lib\\OAuth\\OAuth.js","resolved":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\@aws-amplify\\auth\\lib\\OAuth\\urlOpener.js"},{"name":"./oauthStorage","loc":{"line":60,"column":27},"parent":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\@aws-amplify\\auth\\lib\\OAuth\\OAuth.js","resolved":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\@aws-amplify\\auth\\lib\\OAuth\\oauthStorage.js"},{"name":"../types/Auth","loc":{"line":61,"column":21},"parent":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\@aws-amplify\\auth\\lib\\OAuth\\OAuth.js","resolved":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\@aws-amplify\\auth\\lib\\types\\Auth.js"},{"name":"@aws-amplify/core","loc":{"line":62,"column":21},"parent":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\@aws-amplify\\auth\\lib\\OAuth\\OAuth.js","resolved":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\@aws-amplify\\core\\lib\\index.js"},{"name":"crypto-js/sha256","loc":{"line":63,"column":21},"parent":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\@aws-amplify\\auth\\lib\\OAuth\\OAuth.js","resolved":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\crypto-js\\sha256.js"},{"name":"crypto-js/enc-base64","loc":{"line":64,"column":21},"parent":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\@aws-amplify\\auth\\lib\\OAuth\\OAuth.js","resolved":"C:\\Users\\太田遥人\\Desktop\\auth-kampo\\node_modules\\crypto-js\\enc-base64.js"}],"generated":{"js":"\"use strict\";\n/*\n * Copyright 2017-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\n * the License. A copy of the License is located at\n *\n *     http://aws.amazon.com/apache2.0/\n *\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n * and limitations under the License.\n */\nvar __assign = (this && this.__assign) || Object.assign || function(t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n        s = arguments[i];\n        for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n            t[p] = s[p];\n    }\n    return t;\n};\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar url_1 = require(\"url\"); // Used for OAuth parsing of Cognito Hosted UI\nvar urlOpener_1 = require(\"./urlOpener\");\nvar oAuthStorage = require(\"./oauthStorage\");\nvar Auth_1 = require(\"../types/Auth\");\nvar core_1 = require(\"@aws-amplify/core\");\nvar SHA256 = require(\"crypto-js/sha256\");\nvar Base64 = require(\"crypto-js/enc-base64\");\nvar AMPLIFY_SYMBOL = ((typeof Symbol !== 'undefined' && typeof Symbol.for === 'function') ?\n    Symbol.for('amplify_default') : '@@amplify_default');\nvar dispatchAuthEvent = function (event, data, message) {\n    core_1.Hub.dispatch('auth', { event: event, data: data, message: message }, 'Auth', AMPLIFY_SYMBOL);\n};\nvar logger = new core_1.ConsoleLogger('OAuth');\nvar OAuth = /** @class */ (function () {\n    function OAuth(_a) {\n        var config = _a.config, cognitoClientId = _a.cognitoClientId, _b = _a.scopes, scopes = _b === void 0 ? [] : _b;\n        this._urlOpener = config.urlOpener || urlOpener_1.launchUri;\n        this._config = config;\n        this._cognitoClientId = cognitoClientId;\n        this._scopes = scopes;\n    }\n    OAuth.prototype.oauthSignIn = function (responseType, domain, redirectSignIn, clientId, provider) {\n        if (responseType === void 0) { responseType = 'code'; }\n        if (provider === void 0) { provider = Auth_1.CognitoHostedUIIdentityProvider.Cognito; }\n        var state = this._generateState(32);\n        oAuthStorage.setState(state);\n        var pkce_key = this._generateRandom(128);\n        oAuthStorage.setPKCE(pkce_key);\n        var code_challenge = this._generateChallenge(pkce_key);\n        var code_challenge_method = 'S256';\n        var queryString = Object.entries(__assign({ redirect_uri: redirectSignIn, response_type: responseType, client_id: clientId, identity_provider: provider, scopes: this._scopes, state: state }, (responseType === 'code' ? { code_challenge: code_challenge } : {}), (responseType === 'code' ? { code_challenge_method: code_challenge_method } : {}))).map(function (_a) {\n            var k = _a[0], v = _a[1];\n            return encodeURIComponent(k) + \"=\" + encodeURIComponent(v);\n        }).join('&');\n        var URL = \"https://\" + domain + \"/oauth2/authorize?\" + queryString;\n        logger.debug(\"Redirecting to \" + URL);\n        this._urlOpener(URL, redirectSignIn);\n    };\n    OAuth.prototype._handleCodeFlow = function (currentUrl) {\n        return __awaiter(this, void 0, void 0, function () {\n            var code, oAuthTokenEndpoint, client_id, redirect_uri, code_verifier, oAuthTokenBody, body, _a, access_token, refresh_token, id_token, error;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        code = (url_1.parse(currentUrl).query || '')\n                            .split('&')\n                            .map(function (pairings) { return pairings.split('='); })\n                            .reduce(function (accum, _a) {\n                            var k = _a[0], v = _a[1];\n                            var _b;\n                            return (__assign({}, accum, (_b = {}, _b[k] = v, _b)));\n                        }, { code: undefined }).code;\n                        if (!code) {\n                            return [2 /*return*/];\n                        }\n                        oAuthTokenEndpoint = 'https://' + this._config.domain + '/oauth2/token';\n                        dispatchAuthEvent('codeFlow', {}, \"Retrieving tokens from \" + oAuthTokenEndpoint);\n                        client_id = Auth_1.isCognitoHostedOpts(this._config)\n                            ? this._cognitoClientId\n                            : this._config.clientID;\n                        redirect_uri = Auth_1.isCognitoHostedOpts(this._config)\n                            ? this._config.redirectSignIn\n                            : this._config.redirectUri;\n                        code_verifier = oAuthStorage.getPKCE();\n                        oAuthTokenBody = __assign({ grant_type: 'authorization_code', code: code,\n                            client_id: client_id,\n                            redirect_uri: redirect_uri }, (code_verifier ? { code_verifier: code_verifier } : {}));\n                        logger.debug(\"Calling token endpoint: \" + oAuthTokenEndpoint + \" with\", oAuthTokenBody);\n                        body = Object.entries(oAuthTokenBody)\n                            .map(function (_a) {\n                            var k = _a[0], v = _a[1];\n                            return encodeURIComponent(k) + \"=\" + encodeURIComponent(v);\n                        })\n                            .join('&');\n                        return [4 /*yield*/, fetch(oAuthTokenEndpoint, {\n                                method: 'POST',\n                                headers: {\n                                    'Content-Type': 'application/x-www-form-urlencoded'\n                                },\n                                body: typeof URLSearchParams !== 'undefined' ? new URLSearchParams(body) : body\n                            })];\n                    case 1: return [4 /*yield*/, (_b.sent()).json()];\n                    case 2:\n                        _a = _b.sent(), access_token = _a.access_token, refresh_token = _a.refresh_token, id_token = _a.id_token, error = _a.error;\n                        if (error) {\n                            throw new Error(error);\n                        }\n                        return [2 /*return*/, {\n                                accessToken: access_token,\n                                refreshToken: refresh_token,\n                                idToken: id_token\n                            }];\n                }\n            });\n        });\n    };\n    OAuth.prototype._handleImplicitFlow = function (currentUrl) {\n        return __awaiter(this, void 0, void 0, function () {\n            var _a, id_token, access_token;\n            return __generator(this, function (_b) {\n                _a = url_1.parse(currentUrl).hash\n                    .substr(1) // Remove # from returned code\n                    .split('&')\n                    .map(function (pairings) { return pairings.split('='); })\n                    .reduce(function (accum, _a) {\n                    var k = _a[0], v = _a[1];\n                    var _b;\n                    return (__assign({}, accum, (_b = {}, _b[k] = v, _b)));\n                }, {\n                    id_token: undefined, access_token: undefined\n                }), id_token = _a.id_token, access_token = _a.access_token;\n                dispatchAuthEvent('implicitFlow', {}, \"Got tokens from \" + currentUrl);\n                logger.debug(\"Retrieving implicit tokens from \" + currentUrl + \" with\");\n                return [2 /*return*/, {\n                        accessToken: access_token,\n                        idToken: id_token,\n                        refreshToken: null\n                    }];\n            });\n        });\n    };\n    OAuth.prototype.handleAuthResponse = function (currentUrl) {\n        return __awaiter(this, void 0, void 0, function () {\n            var urlParams, error, error_description;\n            return __generator(this, function (_a) {\n                urlParams = currentUrl ? __assign({}, (url_1.parse(currentUrl).hash || '#').substr(1)\n                    .split('&')\n                    .map(function (entry) { return entry.split('='); })\n                    .reduce(function (acc, _a) {\n                    var k = _a[0], v = _a[1];\n                    return (acc[k] = v, acc);\n                }, {}), (url_1.parse(currentUrl).query || '')\n                    .split('&')\n                    .map(function (entry) { return entry.split('='); })\n                    .reduce(function (acc, _a) {\n                    var k = _a[0], v = _a[1];\n                    return (acc[k] = v, acc);\n                }, {})) : {};\n                error = urlParams.error, error_description = urlParams.error_description;\n                if (error) {\n                    throw new Error(error_description);\n                }\n                this._validateState(urlParams);\n                logger.debug(\"Starting \" + this._config.responseType + \" flow with \" + currentUrl);\n                if (this._config.responseType === 'code') {\n                    return [2 /*return*/, this._handleCodeFlow(currentUrl)];\n                }\n                else {\n                    return [2 /*return*/, this._handleImplicitFlow(currentUrl)];\n                }\n                return [2 /*return*/];\n            });\n        });\n    };\n    OAuth.prototype._validateState = function (urlParams) {\n        if (!urlParams) {\n            return;\n        }\n        var savedState = oAuthStorage.getState();\n        var returnedState = urlParams.state;\n        // This is because savedState only exists if the flow was initiated by Amplify\n        if (savedState && savedState !== returnedState) {\n            throw new Error('Invalid state in OAuth flow');\n        }\n    };\n    OAuth.prototype.signOut = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var oAuthLogoutEndpoint, client_id, signout_uri;\n            return __generator(this, function (_a) {\n                oAuthLogoutEndpoint = 'https://' + this._config.domain + '/logout?';\n                client_id = Auth_1.isCognitoHostedOpts(this._config)\n                    ? this._cognitoClientId\n                    : this._config.oauth.clientID;\n                signout_uri = Auth_1.isCognitoHostedOpts(this._config)\n                    ? this._config.redirectSignOut\n                    : this._config.returnTo;\n                oAuthLogoutEndpoint += Object.entries({\n                    client_id: client_id,\n                    logout_uri: encodeURIComponent(signout_uri)\n                }).map(function (_a) {\n                    var k = _a[0], v = _a[1];\n                    return k + \"=\" + v;\n                }).join('&');\n                dispatchAuthEvent('oAuthSignOut', { oAuth: 'signOut' }, \"Signing out from \" + oAuthLogoutEndpoint);\n                logger.debug(\"Signing out from \" + oAuthLogoutEndpoint);\n                this._urlOpener(oAuthLogoutEndpoint);\n                return [2 /*return*/];\n            });\n        });\n    };\n    OAuth.prototype._generateState = function (length) {\n        var result = '';\n        var i = length;\n        var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';\n        for (; i > 0; --i)\n            result += chars[Math.round(Math.random() * (chars.length - 1))];\n        return result;\n    };\n    OAuth.prototype._generateChallenge = function (code) {\n        return this._base64URL(SHA256(code));\n    };\n    OAuth.prototype._base64URL = function (string) {\n        return string.toString(Base64).replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\n    };\n    OAuth.prototype._generateRandom = function (size) {\n        var CHARSET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';\n        var buffer = new Uint8Array(size);\n        if (typeof window !== 'undefined' && !!(window.crypto)) {\n            window.crypto.getRandomValues(buffer);\n        }\n        else {\n            for (var i = 0; i < size; i += 1) {\n                buffer[i] = (Math.random() * CHARSET.length) | 0;\n            }\n        }\n        return this._bufferToString(buffer);\n    };\n    OAuth.prototype._bufferToString = function (buffer) {\n        var CHARSET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n        var state = [];\n        for (var i = 0; i < buffer.byteLength; i += 1) {\n            var index = buffer[i] % CHARSET.length;\n            state.push(CHARSET[index]);\n        }\n        return state.join('');\n    };\n    return OAuth;\n}());\nexports.default = OAuth;\n"},"sourceMaps":{"js":{"version":3,"file":"OAuth.js","sourceRoot":"","sources":["../../src/OAuth/OAuth.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright 2017-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\n * the License. A copy of the License is located at\n *\n *     http://aws.amazon.com/apache2.0/\n *\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n * and limitations under the License.\n */\n\n\nimport { parse } from 'url';  // Used for OAuth parsing of Cognito Hosted UI\nimport { launchUri } from './urlOpener';\nimport * as oAuthStorage from './oauthStorage';\n\nimport {\n  OAuthOpts,\n  isCognitoHostedOpts,\n  CognitoHostedUIIdentityProvider\n} from '../types/Auth';\n\nimport {\n  ConsoleLogger as Logger,\n  Hub\n} from '@aws-amplify/core';\n\nconst SHA256 = require(\"crypto-js/sha256\");\nconst Base64 = require(\"crypto-js/enc-base64\");\n\nconst AMPLIFY_SYMBOL = ((typeof Symbol !== 'undefined' && typeof Symbol.for === 'function') ?\n    Symbol.for('amplify_default') : '@@amplify_default') as Symbol;\n\nconst dispatchAuthEvent = (event:string, data:any, message:string) => {\n  Hub.dispatch('auth', { event, data, message }, 'Auth', AMPLIFY_SYMBOL);\n};\n\nconst logger = new Logger('OAuth');\n\nexport default class OAuth {\n\n  private _urlOpener;\n  private _config;\n  private _cognitoClientId;\n  private _scopes;\n\n  constructor({\n    config,\n    cognitoClientId,\n    scopes = []\n  }: {\n    scopes: string[],\n    config: OAuthOpts,\n    cognitoClientId: string\n  }) {\n    this._urlOpener = config.urlOpener || launchUri;\n    this._config = config;\n    this._cognitoClientId = cognitoClientId;\n    this._scopes = scopes;\n  }\n\n  public oauthSignIn(\n    responseType = 'code',\n    domain: string,\n    redirectSignIn: string,\n    clientId: string,\n    provider: CognitoHostedUIIdentityProvider | string = CognitoHostedUIIdentityProvider.Cognito) {\n\n    const state = this._generateState(32);\n    oAuthStorage.setState(state);\n\n    const pkce_key = this._generateRandom(128);\n    oAuthStorage.setPKCE(pkce_key);\n    \n    const code_challenge = this._generateChallenge(pkce_key);\n    const code_challenge_method = 'S256';\n\n    const queryString = Object.entries({\n      redirect_uri: redirectSignIn,\n      response_type: responseType, \n      client_id: clientId,\n      identity_provider: provider,\n      scopes: this._scopes,\n      state,\n      ...(responseType === 'code'?{code_challenge}:{}),\n      ...(responseType === 'code'?{code_challenge_method}:{})\n    }).map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');\n\n    const URL = `https://${domain}/oauth2/authorize?${queryString}`;\n    logger.debug(`Redirecting to ${URL}`);\n    this._urlOpener(URL, redirectSignIn);\n  }\n\n  private async _handleCodeFlow(currentUrl: string) {\n    /* Convert URL into an object with parameters as keys\n    { redirect_uri: 'http://localhost:3000/', response_type: 'code', ...} */\n    const { code } = (parse(currentUrl).query || '')\n      .split('&')\n      .map((pairings) => pairings.split('='))\n      .reduce((accum, [k, v]) => ({ ...accum, [k]: v }), { code: undefined });\n\n    if (!code) { return; }\n\n    \n    const oAuthTokenEndpoint = 'https://' + this._config.domain + '/oauth2/token';\n      \n    dispatchAuthEvent(\n      'codeFlow',\n      {},\n      `Retrieving tokens from ${oAuthTokenEndpoint}`\n    );\n\n    const client_id = isCognitoHostedOpts(this._config)\n      ? this._cognitoClientId\n      : this._config.clientID;\n\n    const redirect_uri = isCognitoHostedOpts(this._config)\n      ? this._config.redirectSignIn\n      : this._config.redirectUri;\n\n    const code_verifier = oAuthStorage.getPKCE();\n\n    const oAuthTokenBody = {\n      grant_type: 'authorization_code',\n      code,\n      client_id,\n      redirect_uri,\n      ...(code_verifier ? { code_verifier } : {})\n    };\n\n    logger.debug(`Calling token endpoint: ${oAuthTokenEndpoint} with`, oAuthTokenBody);\n\n    const body = Object.entries(oAuthTokenBody)\n      .map(([k, v]) =>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`)\n      .join('&');\n\n    const { access_token, refresh_token, id_token, error } = await (await fetch(oAuthTokenEndpoint, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: typeof URLSearchParams !== 'undefined' ? new URLSearchParams(body) : body\n      }) as any).json();\n\n      if (error) {\n        throw new Error(error);\n      }\n\n      return {\n        accessToken: access_token,\n        refreshToken: refresh_token,\n        idToken: id_token\n      };\n  }\n\n  private async _handleImplicitFlow(currentUrl: string) {\n\n    const { id_token, access_token } = parse(currentUrl).hash\n      .substr(1) // Remove # from returned code\n      .split('&')\n      .map((pairings) => pairings.split('='))\n      .reduce((accum, [k, v]) => ({ ...accum, [k]: v }), {\n        id_token: undefined, access_token: undefined\n      });\n\n    dispatchAuthEvent(\n      'implicitFlow',\n      {},\n      `Got tokens from ${currentUrl}`\n    );\n    logger.debug(`Retrieving implicit tokens from ${currentUrl} with`);\n\n    return {\n      accessToken: access_token,\n      idToken: id_token,\n      refreshToken: null\n    };\n  }\n\n  public async handleAuthResponse(currentUrl?: string) {\n    const urlParams = currentUrl ? {\n      ...(parse(currentUrl).hash || '#').substr(1)\n        .split('&')\n        .map(entry => entry.split('='))\n        .reduce((acc, [k, v]) => (acc[k] = v, acc), {}),\n      ...(parse(currentUrl).query || '')\n        .split('&')\n        .map(entry => entry.split('='))\n        .reduce((acc, [k, v]) => (acc[k] = v, acc), {})\n    } as any : {};\n    const { error, error_description } = urlParams;\n\n    if (error) {\n      throw new Error(error_description);\n    }\n\n    this._validateState(urlParams);\n\n    logger.debug(`Starting ${this._config.responseType} flow with ${currentUrl}`);\n    if (this._config.responseType === 'code') {\n      return this._handleCodeFlow(currentUrl);\n    } else {\n      return this._handleImplicitFlow(currentUrl);\n    }\n  }\n\n  private _validateState(urlParams: any) {\n    if (!urlParams) { return; }\n\n    const savedState = oAuthStorage.getState();\n    const { state: returnedState } = urlParams;\n\n    // This is because savedState only exists if the flow was initiated by Amplify\n    if (savedState && savedState !== returnedState) {\n      throw new Error('Invalid state in OAuth flow');\n    }\n  }\n\n  public async signOut() {\n    let oAuthLogoutEndpoint = 'https://' + this._config.domain + '/logout?';\n\n    const client_id = isCognitoHostedOpts(this._config)\n      ? this._cognitoClientId\n      : this._config.oauth.clientID;\n\n    const signout_uri = isCognitoHostedOpts(this._config)\n      ? this._config.redirectSignOut\n      : this._config.returnTo;\n\n    oAuthLogoutEndpoint += Object.entries({\n      client_id,\n      logout_uri: encodeURIComponent(signout_uri)\n    }).map(([k, v]) => `${k}=${v}`).join('&');\n\n    dispatchAuthEvent(\n      'oAuthSignOut',\n      {oAuth: 'signOut'},\n      `Signing out from ${oAuthLogoutEndpoint}`\n    );\n    logger.debug(`Signing out from ${oAuthLogoutEndpoint}`);\n    \n    this._urlOpener(oAuthLogoutEndpoint);\n  }\n\n  private _generateState(length: number) {\n    let result = '';\n    let i = length;\n    const chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';\n    for (; i > 0; --i) result += chars[Math.round(Math.random() * (chars.length - 1))];\n    return result;\n  }\n\n  private _generateChallenge(code:string) {\n    return this._base64URL(SHA256(code));\n  }\n\n  private _base64URL(string) {\n    return string.toString(Base64).replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\n  }\n\n  private _generateRandom(size: number) {\n    const CHARSET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';\n    const buffer = new Uint8Array(size);\n    if (typeof window !== 'undefined' && !!(window.crypto)) {\n      window.crypto.getRandomValues(buffer);\n    } else {\n      for (let i = 0; i < size; i += 1) {\n        buffer[i] = (Math.random() * CHARSET.length) | 0;\n      }\n    }\n    return this._bufferToString(buffer);\n  }\n\n  private _bufferToString(buffer: Uint8Array) {\n    const CHARSET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n    const state = [];\n    for (let i = 0; i < buffer.byteLength; i += 1) {\n      const index = buffer[i] % CHARSET.length;\n      state.push(CHARSET[index]);\n    }\n    return state.join('');\n  }\n}\n\n"]}},"error":null,"hash":"5af592b8d6b80ef6f7adfc297497e062","cacheData":{"env":{}}}